%-------------------------------------------------------------------------------
% TEYSSIER Maxime
% IUT Béziers - LP Réseaux et Télécommunications - Promotion: 2018/2019
% Stage IUT de Béziers
% Intitulé: WalkersVision
% Tuteur: DRUON Sebastien
%-------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
% Titre du fichier
%-------------------------------------------------------------------------------
\title{Rapport_WalkersVision}

%-------------------------------------------------------------------------------
% Fonctionnalités
%-------------------------------------------------------------------------------
\documentclass[12pt, french]{report}
\usepackage[a4paper]{geometry}
\usepackage[myheadings]{fullpage}
\usepackage[french]{babel}
\usepackage{minted}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{sectsty}
\usepackage[font=small, labelfont=bf]{caption}
\usepackage{fourier}
\usepackage[protrusion=true, expansion=true]{microtype}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{graphicx, wrapfig, subcaption, setspace, booktabs}
\usepackage{titletoc}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{tikz}
\usepackage{multicol}
\usepackage{xcolor}
\usepackage{url}
\onehalfspacing
\setcounter{tocdepth}{5}
\setcounter{secnumdepth}{5}
\renewcommand{\thesection}{\arabic{section}}
\newcommand{\HRule}[1]{\rule{\linewidth}{#1}}
\lstset{basicstyle=\ttfamily,
  showstringspaces=false,
  commentstyle=\color{red},
  keywordstyle=\color{blue}
}

\usepackage{tikz}
\usepackage{amsmath}

%-------------------------------------------------------------------------------
%Début du document
%-------------------------------------------------------------------------------
\begin{document}

%-------------------------------------------------------------------------------
% En-tête & pied de page
%-------------------------------------------------------------------------------
\pagestyle{fancy}
\fancyhf{}
\setlength\headheight{15pt}
\fancyhead[L]{Maxime TEYSSIER}
\fancyhead[R]{IUT de Béziers}
\fancyfoot[R]{Page \thepage\ sur \pageref{LastPage}}

%-------------------------------------------------------------------------------
% Page de garde
%-------------------------------------------------------------------------------

\title{\includegraphics[width=0.56\textwidth]{Images/IUT-Beziers.png}\\
		\normalsize\textsc{}
		\HRule{2pt} \\
        \LARGE \textbf{\uppercase{Rapport de stage\\Comptage et statistiques de passants sur une place publique par analyse}}
		\HRule{2pt} 
		\normalsize 04 Juin 2019 - 27 Août 2019 \vspace*{3\baselineskip}
        }
\author{Stagiaire: Maxime TEYSSIER\\Tuteur: Sébastien DRUON\\ 
        \includegraphics[width=0.25\textwidth]{Images/UM.png}
        \date{}\\
        }
\maketitle
\clearpage
\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%% Page blanche sans mise en page %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\strut																		  %
\thispagestyle{empty}														  %
\newpage																	  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------Remerciements--------------------------------------------------
\section*{Remerciements}
J'adresse mes remerciements aux personnes qui m'ont permis à réaliser ce stage au sein de l'IUT de Béziers.

\bigskip

En premier lieu, M. Sébastien DRUON,\\
Je souhaite remercier\\
Je tiens à remercier aussi \\

\newpage

%-------------------------------------------------------------------------------
%-------------------------------------------------------------------------------
% Sommaire								\usepackage{amsmath}									   |
%-------------------------------------------------------------------------------

\tableofcontents
\clearpage 

%-------------------------------------------------------------------------------
% Début des écrits															   |
%-------------------------------------------------------------------------------

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\startcontents[mainsections]%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}

    % Mise en explication du sujet
    % Identification du besoin
    % Modelisation du terrain 
    % 


% A la recherche d'une intro
    % 1/
    %"Les recensements de population constituent la source principale des études sociodémographiques portant sur le local, et en particulier sur le niveau infra communal, celui des quartiers. Ils permettent des descriptions des caractéristiques du peuplement des quartiers sous l’aspect structurel en appréciant les écarts avec leur environnement proche, par exemple celui de la commune ou de l’unité urbaine à laquelle ils appartiennent." \url{www.cairn.info/revue-francaise-des-affaires-sociales-2001-3-page-39.htm}

    % 2/
    % le domaine de vision par ordinateur, poussé par les progrès scientifiques et technologiques récents, s’oriente vers l’analyse en temps réel des scènes comportant des sujets humains. \url{https://tel.archives-ouvertes.fr/tel-00004804/document} - titre / auteur: Vision par ordinateur pour l’interaction homme-machine fortement couplée - De François Bérard - Thèse




\newpage
\section*{Présentation}
\subsection*{L'établissement}
\subsection*{Les missions}
\subsection*{Horaires}
\newpage

\section{Les missions}
\newpage




\section{Caméra}
\subsection{Calibration}
\subsubsection{Vision}
Lorsque l'on prend une photo, le capteur perçoit un point sur un plan 2D (2 dimension). Le schéma ci-dessous présente un plan orthonormé en 3D, avec comme axes x,y et z. Lorsque l'on inscrit un pixel sur une image, par exemple "m", nous avons pris la valeur du point M sur ses axes x et y car le capteur n'a pas de notion de profondeur, qui est la dimension manquante, la z.

\begin{center}
    \begin{tikzpicture}
    \path(0,-0.2) node{O};
    \path(0,2.2) node{Y};
    \path(2.2,-0.5) node{Z};
    \path(1.5,1.7) node{X};
    \path(8,2.3) node{M(X,Y,Z)};
    \path(3.9,1.3) node{m};
    \path(3.9,0.98) node{x};
    % Repere 0
    \draw[->](0,0) -- (2,-0.5); % Axe Z
    \draw[->](0,0) -- (1.5,1.5); % Axe X
    \draw[->](0,0) -- (0,2); % Axe Y
    % Image perçu
    \draw[-](3,-2)--(3,2); % Gauche
    \draw[-](3,2)--(5,4) ;% Haut
    \draw[-](5,4)--(5,0) ;% Droit
    \draw[-](5,0)--(3,-2); % Bas
    % Exemple de perception d'un point sur une image
    \draw[-](0,0) -- (8,2); % Vecteur M 
    \draw(8,2) circle (0.05); % Vecteur M 
    \end{tikzpicture}
\end{center}

Le point \textbf{M} à pour valeur x,y,z. Que l'on écrit: $$\textbf{M}\begin{bmatrix}x\\y\\z\end{bmatrix}$$

Sur un plan en 2D (Hauteur[Y]/Profondeur[Z]), nous avons:\\

\begin{center}
    \begin{tikzpicture}
    \path(0,-0.2) node{O};
    \path(0,2.2) node{Y};
    \path(6.15,0) node{Z};
    \path(-0.2,0.2) node{X};
    \path(7,1.5) node{M(x,y,z)};
    \path(3.4,0.4) node{V};
    \path(5.7,0.75) node{y};
    \path(1.5,-1) node{f}; % f
    \path(2.75,-2) node{z}; % f
    \path(2.7,1) node{m(u,v)}; % f
    \path(3,0.75) node{x}; % f
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \draw[->](0,0) -- (6,0); % Axe Z
    \draw[->](0,0) -- (0,2); % Axe Y
    \draw[-](0,0) -- (6,1.5); % Vecteur M
    \draw (6,1.5) circle (0.05);
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \draw[-,dashed](3,-1) -- (3,2); % Barre V
    \draw[-,dashed](5.5,-2) -- (5.5,2); % Barre Y
    \draw[<->](0,-0.65) -- (3,-0.65); % Barre f 
    \draw[<->](0,-1.5) -- (5.5,-1.5); % Barre z
    \end{tikzpicture}
\end{center}
Ce point de vue nous permet d'appliquer le théorème de Thalès pour récupérer des informations. Nous pouvons effectuer : $\frac{v}{y}$ = $\frac{f}{z}$ \\

Ainsi on peut en déduire de : $v=\frac{fY}{z}$ et $u=\frac{fX}{Z}$

\subsubsection{Erreur de centrage}

Nous pouvons écrire la matrice: 
$$\left\{ 
    \begin{array}{ll}
        v=\frac{fY}{Z}+V0  \\ \\
        u=\frac{fX}{Z}+U0
    \end{array} \\
\right. $$ \\

Que l'on peut écrire: 
$$\left\{ 
    \begin{array}{ll}
        v=\frac{fY+V0Z}{Z} \\ \\
        u=\frac{fX+U0Z}{Z}
    \end{array} \\
\right. $$

La préférence de coordonnée homogène nous fait écrire le système:
$$\left\{ 
    \begin{array}{ll}
        v'=fY+U0\\ \\
        u'=fX+U0 \\ \\
        w'=Z
    \end{array} \\
\right. $$

Avec ces nouvelles forme d'écriture nous écrivons: $u=\frac{u'}{w'}$ et $v=\frac{v'}{w'}$

\subsubsection{Matrice de projection}
Ainsi la matrice s'écrit:
$$\begin{matrix}
    
    \underbrace{\begin{bmatrix}
        u'\\v'\\w'\\
    \end{bmatrix}}_{\text{Coord. H. pixel}}
    
    =\hspace{0.2cm}
    
    \underbrace{\begin{bmatrix}
        \alpha f & \textit{s} & u0\\
        0 & \beta f & v0\\
        0 & 0 & 1\\
    \end{bmatrix}}_{\text{Matrice de projection}}
    
    \hspace{0.5cm}
    
    \underbrace{\begin{bmatrix}
        X\\Y\\Z\\
    \end{bmatrix}}_{\text{Coord. 3D du point}}
\end{matrix}$$

\textit{ \textbf{$\alpha$} et \textbf{$\beta$} sont la densité de pixel et \textbf{s} est le "skew"(qui tant vers 0).}\\

Si nous avons la valeur de \textbf{u} et de \textbf{v}, par exemple: u=310, v=240, nous avons pas le moyen de savoir la valeur de \textbf{w} (étant le facteur de profondeur de l'objet).\\
Il faut passer sous un modèle 3D:

\begin{center}
    \begin{tikzpicture}
        \path(6,-2.2) node{O\tiny{1}};
        \path(0,-0.2) node{O\tiny{0}};
        \path(3,1.2) node{\textbf{w}};
        \path(4,1.55) node{\textbf{w1}};
        \path(5,1.85) node{\textbf{w2}};
        \path(6,2.15) node{\textbf{w3}};
        \path(0,-0.2) node{O\tiny{1}};
        
        % Repere 
        \draw[->](0,0) -- (0,2); 
        \draw[->](0,0) -- (3.5,0); 
        \draw[->](6,-2) -- (4.5,-1); 
        \draw[->](6,-2) -- (6.5,-1); 
        
        % Exemple de perception d'un point sur une image
        \draw[-](0,0) -- (6,2);
        \draw[-](6,-2) -- (2.5,1.5);
        \draw(3,0.99) circle (0.05);
        \draw(4,1.33) circle (0.05);
        \draw(5,1.66) circle (0.05);
        \draw(6,1.99) circle (0.05);
    \end{tikzpicture}
\end{center}
 
Avoir une deuxième point de vue nous permet de définir \textbf{w}.
 
 \subsubsection{Changement de repères}
 
 \begin{center}
    \begin{tikzpicture}
        \path(0,-0.2) node{R\tiny{0}};
        \path(3,-2.2) node{R\tiny{1}};
        \path(5,1) node{x};
        \path(6,1) node{\textbf{M$\begin{pmatrix}x\\y\\z\end{pmatrix}$}};
        \path(6.7,0.3) node{R\tiny{0}};
        % Repères
        \draw[->](0,0) -- (0,2); 
        \draw[->](0,0) -- (2,0);
        \draw[->](3,-2) -- (3,0); 
        \draw[->](3,-2) -- (5,-2);
        % Marqueur
        \draw(5,1) circle (0.18);
        % Visu CAM
        \draw[->](0,0) -- (3,0.65);
        \draw[->](3,-2) -- (4.35,0);
        % Arc de cercle
        \draw[<->] (2,-2) arc (-85:-170:1.7);
     \end{tikzpicture}
\end{center}

Pour passer de la vue R\small{0} à la vue R\small{1} il faut utiliser une matrice de passage:\\

$$ \begin{matrix}
    
    \begin{pmatrix}
        x\\y\\z\\1
    \end{pmatrix}_{\text{R1}}
    
    =
    
    \underbrace{^1T_^0}_{\text{Matrice de passage R0 vers R1}}
    
    \hspace{0.5cm}
    
    \underbrace{\begin{pmatrix}
        X\\Y\\Z\\1\\
    \end{pmatrix}_{\text{R0}}}_{Sur le plan 0}
    
\end{matrix}$$\\

La matrice de passage donne:


$$ \begin{matrix}
    
    \begin{pmatrix}
        x\\y\\z\\1
    \end{pmatrix}_{\text{R1}}
    =
    \underbrace{\begin{pmatrix}
    R_^1^1 & R_^1^2 & R_^1^3 & T_^x  \\
    R_^2^1 & R_^2^2 & R_^2^3 & T_^y  \\
    R_^3^1 & R_^3^2 & R_^3^3 & T_^z  \\
    0 & 0 & 0 & 1 \\
    \end{pmatrix}}_{\text{Matrice de passage R0 vers R1}}
    \hspace{0.5cm}
    \begin{pmatrix}
        X\\Y\\Z\\1\\
    \end{pmatrix}_{\text{R0}}
    
\end{matrix}$$

Où: 
    \begin{center}
    \begin{matrix}
        R_^1^1 & R_^1^2 & R_^1^3   \\
        R_^2^1 & R_^2^2 & R_^2^3  \\
        R_^3^1 & R_^3^2 & R_^3^3   
    \end{matrix}
    \end{center}
Est la matrice de rotation. Et: \\
    \begin{center}
    \begin{matrix}
         T_^x  \\
         T_^y  \\
         T_^z  
    \end{matrix}
    \end{center}
Est la matrice de translation.

\subsubsection{Vision stéréo}
Le principe de la Vision stéréo est de pouvoir retrouver la position d'un objet sur un espace 3D via plusieurs vues de lui même.
 \begin{center}
    \begin{tikzpicture}
        \path(0,-0.7) node{Caméra0};
        \path(0,-0.2) node{X};
        \path(0,2.3) node{Y};
        \path(2.2,0) node{Z};
        \path(0,-4.2) node{Caméra1};
        \path(6,0.5) node{x};
        \path(7,0.5) node{\textbf{M\begin{pmatrix}X\\Y\\Z\end{pmatrix}}};
        \path(3.5,0.6) node{u,v};
        \path(3.5,-2) node{u',v'};
        % Marqueur
        \draw(6,0.5) circle (0.18);
        \draw(3,0.25) circle (0.05);
        \draw(3,-1.75) circle (0.05);
        % Plan
        \draw[-](3,0) -- (3,2); 
        \draw[-](3,-4) -- (3,-1); 
        % Repères
        \draw[->](0,0) -- (0,2); 
        \draw[->](0,0) -- (2,0);
        \draw[->](0,-4) -- (0,-2); 
        \draw[->](0,-4) -- (2,-4);
        % Visu CAM
        \draw[-](0,0) -- (6,0.5);
        \draw[-](0,-4) -- (6,0.5);
     \end{tikzpicture}
\end{center}

On peu en déduire que: \\

Camera 0: $$\begin{bmatrix}U\\V\\W\\ \end{bmatrix} 
=
\begin{bmatrix}
    f & 0 & u0\\
    0 & f & v0\\
    0 & 0 & 1\\
\end{bmatrix}
\begin{bmatrix}
    X\\Y\\Z
\end{bmatrix}_{\text{\tiny{0}}}$$

Camera 1: $$\begin{bmatrix}U'\\V'\\W'\\ \end{bmatrix}
=
\begin{bmatrix}
    f' & 0 & u0'\\
    0 & f' & v0'\\
    0 & 0 & 1\\
\end{bmatrix}
\begin{bmatrix}
    X\\Y\\Z
\end{bmatrix}_{\text{\tiny{1}}}$$\\
On va définir Caméra 1 sur le plan 0.

$$\text{Camera 1=}\begin{bmatrix}
    f' & 0 & u0'\\
    0 & f' & v0'\\
    0 & 0 & 1\\
\end{bmatrix}
\begin{bmatrix}
    ^1T_^0
\end{bmatrix}
\begin{bmatrix}
    X\\Y\\Z\\
\end{bmatrix}_{\text{\tiny{0}}}
=
\begin{bmatrix}
    f' & 0 & u0'\\
    0 & f' & v0'\\
    0 & 0 & 1\\
\end{bmatrix}
\begin{bmatrix}
    R_^1^1 & R_^1^2 & R_^1^3 & T_^x  \\
    R_^2^1 & R_^2^2 & R_^2^3 & T_^y  \\
    R_^3^1 & R_^3^2 & R_^3^3 & T_^z  \\
    0 & 0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
    X\\Y\\Z\\
\end{bmatrix}_{\text{\tiny{0}}}
$$

\subsubsection{Géométrie épipôlaire}

La géométrie épipôlaire permet d'établir une relation géométrique entre deux images d'une même scène.\\

 \begin{center}
    \begin{tikzpicture}
        % Visu CAM
            \draw[-](0,0) -- (1.5,1.5); % /
            \draw[-](0,0) -- (2,0); % _
            \draw[-](8,0) -- (6.5,1.5); % \
            \draw[-](8,0) -- (6,0); % _
        % Path
            \path(0,-0.2) node{Cam0};
            \path(8,-0.2) node{Cam1};
            \path(-0.5,2) node{Plan0};
            \path(8.5,2) node{Plan1};
            \path(4,4.5) node{Point};\draw(4,4) circle (0.1);
            \path(1.4,0.7) node{E0}; % Epipole 0
            \path(6.6,0.7) node{E1}; % Epipole 1
            \path(1.3,1.5) node{p};  
            \path(1.8,-0.2) node{e};  
            \path(6.8,1.6) node{p'};
            \path(6.2,-0.2) node{e'};  
        % Plan 0
            \draw[-](2,-1) -- (2,2); % plan0 | Droit
            \draw[-](2,-1) -- (0,1); % plan0 \ Bas
            \draw[-](0,1) -- (0,4); % plan0 | Gauche
            \draw[-](0,4) -- (2,2); % plan0 \ Haut
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            \draw[-,densely dotted](2.1,0) -- (5.9,0); % plan0
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        % Plan 1
            \draw[-](6,-1) -- (6,2); % plan1 | Gauche 
            \draw[-](8,4) -- (6,2); % plan0 / Bas
            \draw[-](8,1) -- (8,4); % plan0 | Droit
            \draw[-](6,-1) -- (8,1); % plan0 / Haut
        % Point to Cam 
            \draw[-,densely dotted](4,4) -- (2,2); % Point to cam0
            \draw[-,densely dotted](4,4) -- (6,2); % Point to cam1
        % Droites épipolaires
             \draw[-,dashed](1.5,1.5) -- (1.9,0); % Plan 0
             \draw[-,dashed](6.1,0) -- (6.5,1.5); % Plan 1
        % Marqueur
            \draw(1.9,0) circle (0.05); % Plan 0 B
            \draw(1.5,1.5) circle (0.05); % Plan 0 H
            \draw(6.5,1.5) circle (0.05); % Plan 1 B
            \draw(6.1,0) circle (0.05); %Plan 1 H
     \end{tikzpicture}
\end{center}

% URL https://slideplayer.fr/slide/1304090/
\begin{itemize}
    \item[$\bullet$] Un épipôle est le centre de projection d'une caméra vue dans le plan image de l'autre caméra. Seul une droite épipolaire passe par chaque point des images (sauf aux épipôles)
    \item[$\bullet$] Une droite épipolaire est formé par l'épipôle et une point de l'image (multitude de droites épipôlaires par image)
\end{itemize}

Donc: \\
\begin{itemize}
    \item \textbf{E0} et \textbf{E1} sont les droites épipôlaires
    \item \textbf{e} et \textbf{e'} sont les épipôles gauche et droit
    \item \textbf{e} est l'origine de \textbf{Cam1} vue de \textbf{Cam0} et \textbf{e'} est l'origine de \textbf{Cam0} vue de \textbf{Cam1}
\end{itemize} 

\subsubsection{Calibrage d'une caméra}

En tenant compte des dimensions du pixel nous avons 2 facteur qui s'insèrent dans la matrice: \textbf{$\alpha$} et \textbf{$\beta$}.\\

\begin{center}
    $\begin{matrix}
        \begin{bmatrix}
            u\\v\\w\\
        \end{bmatrix}
        =
        \begin{bmatrix}
            \alpha fx &0 &Uo\\
            0&\beta fy&Vo\\
            0&0&1
        \end{bmatrix}
        \begin{bmatrix}
            X\\Y\\Z\\
        \end{bmatrix}
    \end{matrix}$
\end{center}\\
\begin{itemize}
    \item Avec notre capteur, \textbf{$\alpha$} et \textbf{$\beta$} ont pour valeur:  $\frac{1}{25}$ pixel/$\mu$m.
    \item \textbf{x} et \textbf{y} sont exprimés en mètre.
    \item \textbf{$\alpha$ fx} et \textbf{$\beta$ fy} sont alors exprimés en pixel.mètre . 
    \item Uo et Vo  sont exprimés en pixel. 
\end{itemize}







\end{document}



% Ligne de codes
\begin{minted}[
    baselinestretch=1.4,
    bgcolor=lightgray,
    fontsize=\footnotesize]
{c++}

\end{minted}



\begin{center}
    \begin{tikzpicture}
  
        \path(3.5,-2) node{u',v'};
        % Marqueur
        \draw(3,-1.75) circle (0.05);
        % Plan
        \draw[-](3,-4) -- (3,-1); 
        % Repères
        \draw[->](0,0) -- (0,2); 
        % Visu CAM
        \draw[-](0,0) -- (6,0.5);
     \end{tikzpicture}
\end{center}

$$\begin{matrix}
    
    \underbrace{\begin{bmatrix}
        u'\\
    \end{bmatrix}}_{\text{Coord. H. pixel}}
    =
    \underbrace{\begin{bmatrix}
        \alpha f \\
    \end{bmatrix}}_{\text{Matrice de projection}}
    \underbrace{\begin{bmatrix}
        X\\
    \end{bmatrix}}_{\text{Coord. 3D du point}}
\end{matrix}$$